<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asia Pacific eSIM –ú–æ–Ω–≥–æ–ª | 6 —É–ª—Å–∞–¥ –∞–∂–∏–ª–ª–∞—Ö</title>
  <meta name="description" content="Asia Pacific eSIM: Cambodia, Indonesia, Malaysia, Singapore, Thailand, Vietnam. QPay-—Ä —Ç”©–ª”©”©–¥ QR –∫–æ–¥–æ–æ—Ä –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª–Ω—ç." />

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;color:#111;background:#fff}
    .wrap{max-width:980px;margin:0 auto;padding:22px}
    .hero{padding:10px 0 6px}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px}
    .badge{display:inline-block;padding:6px 10px;border:1px solid #eee;border-radius:999px;background:#fafafa;font-size:13px}
    h1{font-size:40px;line-height:1.08;margin:8px 0 10px}
    .sub{opacity:.82;font-size:16px;margin:0 0 14px;max-width:70ch}
    .ctaRow{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .btn{display:inline-block;padding:10px 14px;border:1px solid #ddd;border-radius:12px;text-decoration:none;color:inherit}
    .btn.primary{background:#111;border-color:#111;color:#fff}
    .card{border:1px solid #eee;border-radius:16px;padding:16px;margin:14px 0}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:860px){.grid2{grid-template-columns:1fr 1fr}}
    .planBtn{width:100%;text-align:left;padding:12px;margin:8px 0;border:1px solid #eee;border-radius:14px;background:#fff;cursor:pointer}
    .planBtn:hover{border-color:#ccc}
    .price{font-size:30px;font-weight:900;margin:0}
    .muted{opacity:.7}
    .hr{height:1px;background:#eee;margin:14px 0}
    .links a{display:inline-block;margin:6px 10px 0 0}
    img.qr{max-width:280px;height:auto;border:1px solid #eee;border-radius:12px;padding:8px;background:#fff}
  </style>
</head>

<body>
  <div class="wrap">
    <section class="hero">
      <div class="badges">
        <span class="badge">üåè Asia Pacific eSIM</span>
        <span class="badge">6 —É–ª—Å–∞–¥ –∞–∂–∏–ª–ª–∞–Ω–∞</span>
        <span class="badge">QPay + QR</span>
      </div>

      <h1>Asia Pacific eSIM (6 —É–ª—Å)</h1>
      <p class="sub">
        Cambodia, Indonesia, Malaysia, Singapore, Thailand, Vietnam —É–ª—Å–∞–¥ –∞–∂–∏–ª–ª–∞—Ö –Ω—ç–≥ –±–∞–≥—Ü.
        –ë–∞–≥—Ü–∞–∞ —Å–æ–Ω–≥–æ–æ–¥ QPay-—Ä —Ç”©–ª”©—Ö”©–¥ QR –∫–æ–¥ —à—É—É–¥ –≥–∞—Ä–Ω–∞.
      </p>

      <div class="ctaRow">
        <a class="btn primary" href="#plans">–ë–∞–≥—Ü —Å–æ–Ω–≥–æ—Ö</a>
        <a class="btn" href="/">‚¨Ö “Æ–Ω–¥—Å—ç–Ω —Å–∞–π—Ç —Ä—É—É –±—É—Ü–∞—Ö</a>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px">‚úÖ Supported Countries</h2>
      <div style="display:flex;flex-wrap:wrap;gap:8px">
        <span class="badge">üá∞üá≠ Cambodia</span>
        <span class="badge">üáÆüá© Indonesia</span>
        <span class="badge">üá≤üáæ Malaysia</span>
        <span class="badge">üá∏üá¨ Singapore</span>
        <span class="badge">üáπüá≠ Thailand</span>
        <span class="badge">üáªüá≥ Vietnam</span>
      </div>
      <p class="muted" style="margin:10px 0 0">–ù–∏–π—Ç: 6 —É–ª—Å</p>
    </section>

    <section class="card" id="plans">
      <h2 style="margin:0 0 10px">üßæ –ë–∞–≥—Ü —Å–æ–Ω–≥–æ—Ö</h2>
      <p class="muted" style="margin:0 0 10px">
        (“Æ–Ω—ç –Ω—å –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä MNT –±–æ–ª–∂ —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞. –°–æ–Ω–≥–æ—Å–æ–Ω –±–∞–≥—Ü–∞–∞—Ä QPay invoice “Ø“Ø—Å–≥—ç–Ω—ç.)
      </p>
      <div id="planList">Loading...</div>
    </section>

    <section class="card" id="payBox" style="display:none">
      <h2 style="margin:0 0 10px">üí≥ QPay —Ç”©–ª–±”©—Ä</h2>
      <p class="muted" id="payMeta" style="margin:0 0 10px"></p>
      <div id="qrBox"></div>
      <div class="links" id="urlBox"></div>
      <div class="hr"></div>
      <button class="btn" id="checkBtn" type="button">–¢”©–ª–±”©—Ä —à–∞–ª–≥–∞—Ö</button>
      <span class="muted" id="checkResult" style="margin-left:10px"></span>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px">‚ùì –¢“Ø–≥—ç—ç–º—ç–ª –∞—Å—É—É–ª—Ç</h2>
      <p><strong>–Ø–∞–∂ –∏–¥—ç–≤—Ö–∂“Ø“Ø–ª—ç—Ö –≤—ç?</strong><br>QR –∫–æ–¥ —É–Ω—à—É—É–ª–∂ —Å—É—É–ª–≥–∞–∞–¥ Data Roaming –∞—Å–∞–∞–Ω–∞.</p>
      <p><strong>–°“Ø–ª–∂—ç—ç –±–∞—Ä–∏—Ö–≥“Ø–π –±–æ–ª?</strong><br>Airplane mode ON/OFF —Ö–∏–π–≥—ç—ç–¥ –¥–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ–æ—Ä–æ–π.</p>
    </section>
  </div>

  <script>
    // ===== SETTINGS =====
    const FX = 3680;
    const MARGIN = 0.35;

    // getPlans –æ–¥–æ–æ–≥–æ–æ—Ä 1 —É–ª—Å—ã–Ω code –∞–≤–¥–∞–≥ —Ç—É–ª ‚Äúanchor‚Äù –∫–æ–¥ –∞—à–∏–≥–ª–∞–Ω–∞ (Asia 6-—Å —Å–æ–Ω–≥–æ–≤)
    const ANCHOR_CODE = "SG";

    // ===== HELPERS =====
    function cleanUsd(x){
      return parseFloat(String(x ?? "").replace("$","").trim()) || 0;
    }
    function calcMntFromUsd(usd){
      return Math.round(Number(usd) * FX * (1 + MARGIN));
    }
    function pickUsd(plan){
      // Airhub —Ç–∞–ª–±–∞—Ä –Ω—ç—Ä ”©”©—Ä –±–∞–π–∂ –±–æ–ª–æ—Ö —Ç—É–ª –æ–ª–æ–Ω —Ö—É–≤–∏–ª–±–∞—Ä —à–∞–ª–≥–∞–Ω–∞
      return cleanUsd(
        plan.portalPrice ??
        plan.price ??
        plan.Price ??
        plan["Portal Price"] ??
        plan["PortalPrice"] ??
        plan["PortalPriceUSD"] ??
        0
      );
    }
    function pickTitle(plan){
      return String(plan.planName ?? plan.data ?? plan.name ?? "Asia Pacific");
    }
    function pickDays(plan){
      return String(plan.day ?? plan.days ?? plan.duration ?? "");
    }
    function isAsiaPlan(plan){
      const s = String(plan.countryName ?? plan.Country ?? plan.planName ?? plan.name ?? "").toLowerCase();
      return s.includes("asia pacific") || s === "asia";
    }

    // ===== UI RENDER =====
    fetch(`/.netlify/functions/getPlans?code=${encodeURIComponent(ANCHOR_CODE)}`)
      .then(r => r.json())
      .then(data => {
        const plans = Array.isArray(data.getInformation) ? data.getInformation
                    : Array.isArray(data.data) ? data.data
                    : Array.isArray(data.plans) ? data.plans
                    : [];

        const asiaPlans = plans.filter(isAsiaPlan);

        if (!asiaPlans.length){
          document.getElementById("planList").innerHTML =
            "Asia Pacific –±–∞–≥—Ü –æ–ª–¥—Å–æ–Ω–≥“Ø–π. (getPlans response –¥—ç—ç—Ä planName/countryName —Ç–∞–ª–±–∞—Ä—ã–≥ —à–∞–ª–≥–∞—Ö —Ö—ç—Ä—ç–≥—Ç—ç–π)";
          return;
        }

        document.getElementById("planList").innerHTML = asiaPlans.map(p => {
          const usd = pickUsd(p);
          const mnt = calcMntFromUsd(usd);
          const title = pickTitle(p);
          const days = pickDays(p);

          return `
            <button class="planBtn"
              data-title="${title.replace(/"/g,'&quot;')}"
              data-days="${days.replace(/"/g,'&quot;')}"
              data-amount="${mnt}">
              <div><strong>${title}</strong> ${days ? "‚Ä¢ "+days+" ”©–¥”©—Ä" : ""}</div>
              <div class="price">${mnt.toLocaleString("en-US")} ‚ÇÆ</div>
              <div class="muted">QPay —Ç”©–ª–±”©—Ä “Ø“Ø—Å–≥—ç–Ω—ç</div>
            </button>
          `;
        }).join("");
      })
      .catch(() => {
        document.getElementById("planList").innerHTML = "Plan –∞—á–∞–∞–ª–ª–∞–∂ —á–∞–¥—Å–∞–Ω–≥“Ø–π.";
      });

    // ===== QPAY FLOW =====
    let lastInvoiceId = "";

    document.addEventListener("click", async (e) => {
      const btn = e.target.closest(".planBtn");
      if (!btn) return;

      const amount = Number(btn.dataset.amount || 0);
      const title = btn.dataset.title || "Asia Pacific eSIM";
      const days = btn.dataset.days || "";

      if (!amount) return alert("“Æ–Ω—ç –±–æ–¥–æ–≥–¥—Å–æ–Ω–≥“Ø–π.");

      const payload = {
        amount,
        orderId: "ASIA-" + Date.now(),
        description: `${title} ${days}`.trim()
      };

      const r = await fetch("/.netlify/functions/qpay-create-invoice", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });

      const j = await r.json().catch(() => ({}));
      if (!j.ok) return alert("QPay –∞–ª–¥–∞–∞: " + JSON.stringify(j));

      lastInvoiceId = j.invoice_id || "";

      document.getElementById("payBox").style.display = "block";
      document.getElementById("payMeta").textContent =
        `${payload.description} ‚Ä¢ ${amount.toLocaleString("en-US")} ‚ÇÆ`;

      document.getElementById("qrBox").innerHTML =
        j.qr_image ? `<img class="qr" alt="QPay QR" src="data:image/png;base64,${j.qr_image}">` : "QR –æ–ª–¥—Å–æ–Ω–≥“Ø–π";

      const urls = Array.isArray(j.urls) ? j.urls : [];
      document.getElementById("urlBox").innerHTML = urls.length
        ? urls.map(u => `<a class="btn" href="${u.link}" target="_blank" rel="noopener">${u.name || "Pay link"}</a>`).join("")
        : "";

      // scroll to payment box
      document.getElementById("payBox").scrollIntoView({behavior:"smooth", block:"start"});
    });

    // ===== PAYMENT CHECK =====
    document.getElementById("checkBtn").addEventListener("click", async () => {
      if (!lastInvoiceId) return alert("Invoice –æ–ª–¥—Å–æ–Ω–≥“Ø–π.");
      document.getElementById("checkResult").textContent = "–®–∞–ª–≥–∞–∂ –±–∞–π–Ω–∞...";

      const r = await fetch("/.netlify/functions/qpay-check", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ invoice_id: lastInvoiceId })
      });

      const j = await r.json().catch(() => ({}));
      document.getElementById("checkResult").textContent =
        j.paid ? "‚úÖ –¢”®–õ”®–ì–î–°”®–ù" : "‚è≥ –¢”©–ª”©–≥–¥”©”©–≥“Ø–π –±–∞–π–Ω–∞";
    });
  </script>
</body>
</html>
