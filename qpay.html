<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QPay — Нэхэмжлэл үүсгэх</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f7f7fb;margin:0}
    .wrap{max-width:920px;margin:36px auto;padding:0 16px}
    h1{margin:0 0 8px;font-size:38px}
    .sub{color:#555;margin:0 0 18px}
    .card{background:#fff;border:1px solid #e7e7ef;border-radius:14px;padding:18px}
    .row{display:flex;gap:14px;flex-wrap:wrap}
    .col{flex:1;min-width:240px}
    label{display:block;font-weight:700;margin:12px 0 6px}
    input,textarea{width:100%;padding:12px 12px;border:1px solid #d8d8e6;border-radius:10px;font-size:16px}
    textarea{min-height:70px}
    .btns{display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap}
    button{border:0;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer}
    .primary{background:#0f172a;color:#fff}
    .secondary{background:#6b7280;color:#fff}
    .err{color:#dc2626;font-weight:800}
    .ok{color:#16a34a;font-weight:800}
    pre{background:#0b1020;color:#e5e7eb;padding:14px;border-radius:12px;overflow:auto}
    .small{font-size:13px;color:#667}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>QPay — Нэхэмжлэл үүсгэх</h1>
    <p class="sub">Энэ хуудас Netlify Function руу дуудлага хийж нэхэмжлэл (QR) үүсгэнэ.</p>

    <div class="card">
      <form id="form">
        <div class="row">
          <div class="col">
            <label for="amount">Дүн (₮)</label>
            <input id="amount" type="number" min="1" step="1" value="1000" required />
          </div>
          <div class="col">
            <label for="orderId">Захиалгын дугаар (orderId)</label>
            <input id="orderId" type="text" placeholder="Ж: ORD-1001" required />
          </div>
        </div>

        <label for="description">Тайлбар</label>
        <textarea id="description">eSIM худалдан авалт</textarea>

        <label for="contact">Имэйл/утас (заавал биш)</label>
        <input id="contact" type="text" placeholder="customer@email.com эсвэл 99xxxxxx" />

        <div class="btns">
          <button class="primary" type="submit">Нэхэмжлэл үүсгэх</button>
          <button class="secondary" type="button" id="btnCheck" disabled>Төлбөр шалгах</button>
          <span id="status" class="err"></span>
        </div>
        <p class="small">Endpoint: <code>/.netlify/functions/qpay-create-invoice</code></p>
      </form>
    </div>

    <div style="height:14px"></div>

    <div class="card">
      <h2 style="margin:0 0 10px">Гаралт</h2>
      <div id="qrBox" style="display:none;margin:10px 0 12px"></div>
      <details>
        <summary style="cursor:pointer;font-weight:800">Raw response</summary>
        <pre id="raw">—</pre>
      </details>

      <h3 style="margin:16px 0 10px">Log / Алдаа</h3>
      <pre id="log">—</pre>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const form = $("form");
  const statusEl = $("status");
  const rawEl = $("raw");
  const logEl = $("log");
  const qrBox = $("qrBox");
  const btnCheck = $("btnCheck");

  let lastInvoiceId = null;

  function setStatus(text, ok=false){
    statusEl.textContent = text || "";
    statusEl.className = ok ? "ok" : "err";
  }

  function log(obj){
    logEl.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  }

  async function postJSON(url, data){
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data),
    });
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch(e) {}
    return { ok: res.ok, status: res.status, text, json };
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const amount = Number($("amount").value);
    const orderId = ($("orderId").value || "").trim();
    const description = ($("description").value || "").trim();
    const contact = ($("contact").value || "").trim();

    if (!amount || !orderId){
      setStatus("amount болон orderId заавал бөглөнө.");
      return;
    }

    setStatus("Ажиллаж байна...");
    qrBox.style.display = "none";
    qrBox.innerHTML = "";
    rawEl.textContent = "—";
    log("Calling qpay-create-invoice...");

    const payload = { amount, orderId, description, contact };

    const r = await postJSON("/.netlify/functions/qpay-create-invoice", payload);

    rawEl.textContent = r.text;

    if (!r.ok){
      setStatus("Алдаа гарлаа");
      log({ http_status: r.status, error: r.json?.error || "Request failed", detail: r.json?.detail || r.text });
      return;
    }

    setStatus("Амжилттай ✅", true);
    log(r.json || r.text);

    const data = r.json || {};
    lastInvoiceId = data.invoice_id || null;

    // QR текст/линк гаргах (QPay-ийн хариунаас шалтгаална)
    const qrText = data.qr_text || data.qr || data.qrCode || data.qr_code;
    if (qrText){
      qrBox.style.display = "block";
      qrBox.innerHTML = `
        <div style="font-weight:800;margin-bottom:6px">QR текст:</div>
        <pre style="margin:0">${String(qrText)}</pre>
      `;
    }

    btnCheck.disabled = !lastInvoiceId;
  });

  btnCheck.addEventListener("click", async () => {
    if (!lastInvoiceId) return;

    setStatus("Шалгаж байна...");
    rawEl.textContent = "—";
    log("Calling qpay-check...");

    const r = await postJSON("/.netlify/functions/qpay-check", { invoice_id: lastInvoiceId });
    rawEl.textContent = r.text;

    if (!r.ok){
      setStatus("Шалгах үед алдаа гарлаа");
      log({ http_status: r.status, error: r.json?.error || "Request failed", detail: r.json?.detail || r.text });
      return;
    }

    setStatus("Шалгалт OK ✅", true);
    log(r.json || r.text);
  });
</script>
</body>
</html>
